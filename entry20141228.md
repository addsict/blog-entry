Web アプリケーションに HAL を適用する
===
[HAL](http://stateless.co/hal_specification.html) (Hypertext Application Language) とは Web API でやり取りされるリソースを、ハイパーメディアとしても扱えるようにしようと考えられた仕様です。
ハイパーメディアとは HTML のアンカータグをイメージするとわかりやすいですが、ドキュメントといったメディアがリンクを介して繋がっている状態のことを指します。
例えば通常の Web API で表されるリソース間は特別何かで繋がっているわけではなく、お互いのリソースがある意味孤立した状態にありますが、そこにリンクを含めてあげることでお互いのリソース間を行き来することが出来るようになります。

HTML と HAL をハイパーメディアの観点で言うと、

- HTML: 人間が操作するためのハイパーメディア
- HAL: 機械が操作するためのハイパーメディア

このような感じになるでしょうか。

具体的にリソースを HAL + JSON で表すとこんな感じになります。

```json
{
    "userId": 10,
    "lastOrderDate": "Mon, 07 Jul 2014 18:26:21 GMT",
    "_links": {
        "self": { "href": "/users/10/orders" },
        "next": { "href": "/users/10/orders?page=2" }
    },
    "_embedded": {
        "orders": [{
            "orderId": 12,
            "orderDate": "Mon, 01 Jul 2014 18:26:21 GMT",
            "_links": {
                "self": { "href": "/users/10/orders/12" },
            }
        }, {
            "orderId": 11,
            "orderDate": "Mon, 01 Jul 2014 18:26:21 GMT",
            "_links": {
                "self": { "href": "/users/10/orders/11" },
            }
        }]
    }
}
```

`userId` や `lastOrderDate` といったリソースの情報と共に、それに付随したリンクが `_links` というプロパティに含まれています。
このリソースを使用するクライアントはそのリンクを「辿る」ことにより、別のリソースの操作を行うことができます。

こういったハイパーメディアを Web API に利用する考えは [HATEOAS](http://uehaj.hatenablog.com/entry/hateoas) や [REST Level3](http://martinfowler.com/articles/richardsonMaturityModel.html#level3) など、昨今注目を集めているように思えます。

ブラウザと Web API の相性の悪さ
---
ここで少しブラウザと Web API((ここでは WebAPI を「HTTP プロトコルを利用してリソースを操作するためのコンピュータ用のインターフェース」として考えています。)) の関係について考えてみます。
ブラウザは人間が操作するものであり、HTML 上のリンクをクリックして別のドキュメントに遷移出来たりします。
しかし昨今の Web アプリはそういった画面遷移の他にも、JavaScript で Web API 用の URL を組み立て、Ajax を使って呼び出したりすることが多くなっています。
しかしそういった Ajax を使った Web API の呼び出しは、HTML で表せていたハイパーメディアとしての領域をはみ出してしまいます。
リソース同士の繋がりを HTML とは別のもの(例えばクライアントサイドで定義したURLなど)を利用して表現しなければならないからです。
このようにブラウザからの Web API 呼び出しを伴うと、既存のハイパーメディアの上にただ単純に乗っかっていれば済む話ではなくなるため、相性が悪いと個人的には思っています。

ブラウザで HAL を使う
---
そこで、前述した HAL をブラウザでも使いたい！というのが本エントリーの主旨になります。
具体的に言うと、HTML の他に HAL 形式のリソースを同時にブラウザに渡し、JavaScript ではその HAL 形式のリソースを参照します。
同じリソースを表しているのに、HTML と HAL という2つの表現として渡されてしまうという欠点はありますが、クライアントサイドは HAL に書かれているものだけを使えばいいので、サーバサイドとクライアントサイドが疎結合なアーキテクチャになります。

例えば HAL で表したリソースを meta タグに埋め込むと以下のようになります(わかりやすさのために改行を加えています)。

```html
<html>
<head>
    <meta name="hal-resource" content='{
        "_links": {
            "self": { "href": "http://example.com/orders" },
            "next": { "href": "http://example.com/orders?page=2" }
        },
        "_embedded": [{
            "id": "order-1",
            "_links": {
                "self": { "href": "http://example.com/orders/1" }
            }
        }, {
            "id": "order-2",
            "_links": {
                "self": { "href": "http://example.com/orders/2" }
            }
        }]
    }' id="hal-resource">
</head>
<body>
    <ol>
        <li id="order-1">Order 1</li>
        <li id="order-2">Order 2</li>
    </ol>
</body>
</html>
```

JavaScript 側では渡された HAL からリソースのリンクを辿ります。
JavaScript で HAL を扱うには halfred([https://github.com/basti1302/halfred](https://github.com/basti1302/halfred)) というライブラリがおすすめです。

```javascript
var hal = $("#hal-resource").attr("content");
var resource = halfred.parse(hal);

$.ajax({
    type: "GET",
    url: resource.link("next").href,
    data: {
        amount: 10,
    },
    success: function (...) { ... },
    error: function (...) { ... },
});
```

このように単純にブラウザを HAL のクライアントとみなすことで、Web API との親和性も高くなります。

まとめ
---
HAL を Web アプリケーションに使用する一番わかりやすい利点は、エンドポイントの管理がサーバサイドで完結し疎結合なアーキテクチャになる点です。
また別途 Web API を作っている場合にも、HAL で表しておけばその Web API のレスポンスをそのまま Web アプリケーションに使用できたりするでしょう。

参考
---
- [RESTful Web API 開発をささえる Garage: クックパッド開発者ブログ](http://techlife.cookpad.com/entry/2014/11/06/100000)
- [はじめてのハイパーメディア](https://code.google.com/p/bearsunday/wiki/my_first_hypermedia)
- [Web API The Good Parts](http://www.amazon.co.jp/Web-API-The-Good-Parts/dp/4873116864)
