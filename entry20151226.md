Let's Encrypt 使うと一瞬でサイト
===

[Let's Encrypt](https://letsencrypt.org/) を使ってみたら、ものの10分で証明書の取得とサイトのSSL化ができたので、やり方をメモしておきます。

# 環境

- EC2(Amazon Linux AMI)

# 事前準備

- EPEL が有効になっていること
  - 後述の letsencrypt-auto スクリプトを実行する時に必要になります
- ポート 80 & 443 がセキュリティグループで空いていて、サーバ内で使われていないこと。
  - ACME プロトコル内において、ドメイン検証のためにスタンドアロンの Web サーバが立ち上がり、80 と 443 ポートがバインドされます。
  - cf. [Let's Encrypt を支える ACME プロトコル](http://jxck.hatenablog.com/entry/letsencrypt-acme)

# 証明書の取得

[Let's Encrypt のドキュメント](https://letsencrypt.readthedocs.org/en/latest/using.html)に書いてある通りにやります。

```bash
# EC2 内において
$ git clone https://github.com/letsencrypt/letsencrypt
$ cd letsencrypt
$ ./letsencrypt-auto --debug certonly
```

letsencrypt-auto コマンドを実行すると、Linux の設定画面のような TUI の青い画面が表示され、言われた通りにメールアドレスやドメイン名を入力していきます。
Amazon Linux で動かすにはまだ experimental な機能らしく、 --debug オプションを付ける必要がありました。
この間に裏では ACME プロトコルによるチャレンジが行われており、問題なく終了すると /etc/letsencrypt/live/{domain}/ 以下に証明書等が作られます。

```
$ sudo ls /etc/letsencrypt/live/{domain}
cert.pem  chain.pem  fullchain.pem  privkey.pem
```

- cert.pem : 証明書
- chain.pem : 中間証明書
- fullchain.pem : cert.pem と chain.pem がくっついたもの
- privkey.pem : 秘密鍵

実際に取得した証明書を見てみると、確かに Let's Encrypt の CA による署名が付いていることがわかります。
証明書の有効期限は3ヶ月と短いですね。

```
$ sudo openssl x509 -in /etc/letsencrypt/live/{domain}/cert.pem -text -noout
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            01:45:4d:37:ef:ab:46:11:f5:b9:8d:e5:d0:55:97:af:02:cc
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=US, O=Let's Encrypt, CN=Let's Encrypt Authority X1
        Validity
            Not Before: Dec 26 06:00:00 2015 GMT
            Not After : Mar 25 06:00:00 2016 GMT
    ...
    ...
    ...
```

# Web サーバの SSL 設定

あとは nginx.conf で設定すればok
 
nginx.conf の server ディレクティブに証明書と秘密鍵のパスを指定します。
nginx をリロードして https://{domain}/ でアクセスできれば完了です。

```conf
server {
    listen 443;
    server_name localhost;
    root /var/www/html;
    
    ssl on;
    ssl_certificate /etc/letsencrypt/live/{domain}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{domain}/privkey.pem;
    location / {
    }
}
```

